- name: Setup K8s Cluster
  hosts: all
  become: yes
  roles:
    - role: common

- name: Setup Master node
  hosts: master
  become: yes
  roles:
    - role: master

- name: Setup worker nodes
  hosts: workers
  become: yes
  roles:
    - role: worker

- name: Setup CNI on master
  hosts: master
  become: yes
  tasks:
    - name: Install CNI
      shell: |
        CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
        CLI_ARCH=amd64
        if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
        curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
        sha256sum --check cilium-linux-${CLI_ARCH}.tar.gz.sha256sum
        tar xzvfC cilium-linux-${CLI_ARCH}.tar.gz /usr/local/bin
        rm cilium-linux-${CLI_ARCH}.tar.gz{,.sha256sum}
        cilium install --version 1.16.6
      args:
        executable: /bin/bash
        creates: /usr/local/bin/cilium
      become: yes
